<div *ngIf="isLoading" class="loader-overlay">
    <div class="loader"></div>
</div>

<div class="form-section">
  <div class="inputs-field-set">
    <div class="section">
      <div class="form-section-title">
        <h2 class="edit-firm-header">
          Controllers > <span>{{ firmDetails?.FirmName }}</span>
        </h2>
        <div class="btn">
          <button (click)="createController()">
            <i class="bi bi-pen"></i>
            Create
          </button>
        </div>
      </div>
      <table class="controller-tables">
        <thead>
          <tr>
            <th>Name</th>
            <th>Controller Type</th>
            <th>Registered Number</th>
            <th>Control Type</th>
            <th>% of Holding</th>
            <th>Effective Date</th>
            <th>Cessation Date</th>
            <th>Last Modified By</th>
            <th>Last Modified Date</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let controller of FIRMControllers" (click)="openControllerPopup(controller)">
            <td>{{ controller.OtherEntityName }}</td>
            <td>{{ controller.EntityTypeDesc }}</td>
            <td>{{ controller.RegisteredNum }}</td>
            <td>{{ controller.ControllerControlTypeDesc }}</td>
            <td>{{ controller.PctOfShares }}</td>
            <td>{{ controller.AssnDateFrom }}</td>
            <td>{{ controller.AssnDateTo }}</td>
            <td>{{ controller.LastModifiedByOfOtherEntities }}</td>
            <td>{{ controller.LastModifiedDate }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="inputs-field-set">
    <div class="section">
      <h2 class="edit-firm-header">
        Ultimate Beneficial Owners > <span>{{ firmDetails?.FirmName }}</span>
      </h2>
      <table class="controller-tables">
        <thead>
          <tr>
            <th>Name</th>
            <th>Controller Type</th>
            <th>Registered Number</th>
            <th>Control Type</th>
            <th>% of Holding</th>
            <th>Effective Date</th>
            <th>Cessation Date</th>
            <th>Last Modified By</th>
            <th>Last Modified Date</th>
          </tr>
        </thead>
        <tbody *ngIf="FIRMControllersIndividual?.length > 0; else noRecords">
          <tr *ngFor="let controller of FIRMControllersIndividual" (click)="openControllerPopup(controller)">
            <td>{{ controller.OtherEntityName }}</td>
            <td>{{ controller.EntityTypeDesc }}</td>
            <td>{{ controller.RegisteredNum }}</td>
            <td>{{ controller.ControllerControlTypeDesc }}</td>
            <td>{{ controller.PctOfShares }}</td>
            <td>{{ controller.AssnDateFrom }}</td>
            <td>{{ controller.AssnDateTo }}</td>
            <td>{{ controller.LastModifiedByOfOtherEntities }}</td>
            <td>{{ controller.LastModifiedDate }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <ng-template #noRecords>
      <p class="norecords">---- No records found.</p>
    </ng-template>
  </div>
  <!-- Popup Section -->
  <div *ngIf="isPopupOpen" (click)="closeControllerPopup()" class="contollerPopupOverlay">
    <div (click)="$event.stopPropagation()" class="contollerPopupContent">
      <div class="error-messages">
        <p *ngIf="errorMessages['OtherEntityName']">
          {{ errorMessages['OtherEntityName'] }}
        </p>
        <p *ngIf="errorMessages['EffectiveDate']">
          {{ errorMessages['EffectiveDate'] }}
        </p>
        <p *ngIf="errorMessages['CessationDate']">
          {{ errorMessages['CessationDate'] }}
        </p>
        <p *ngIf="errorMessages['PlaceOfEstablishment']">
          {{ errorMessages['PlaceOfEstablishment'] }}
        </p>
        <p *ngIf="errorMessages['ControllerControlTypeDesc']">
          {{ errorMessages['ControllerControlTypeDesc'] }}
        </p>
        <p *ngIf="errorMessages['PctOfShares']">
          {{ errorMessages['PctOfShares'] }}
        </p>
      </div>
      <!-- Title -->
      <div class="popup-title-btn-row">
        <div class="popup-header">
          <h3>
            Controller Details For {{ selectedController?.OtherEntityName }}
          </h3>
        </div>
        <!-- Save and Cancel Buttons -->

        <button class="close-button" (click)="closeControllerPopup()">
          <i class="bi bi-x-circle close-icon"></i>
        </button>
      </div>

      <!-- Form -->
      <form>
        <div class="inputs-row">
          <div class="input-field">
            <label>Controller Type</label>
            <input [(ngModel)]="selectedController.EntityTypeDesc" name="ControllerType" disabled />
          </div>

          <div class="input-field" *ngIf="
              selectedController.EntityTypeDesc === 'Parent Entity' ||
              selectedController.EntityTypeDesc === 'Corporate Controller' ||
              selectedController.EntityTypeDesc === 'UBO – Corporate' ||
              selectedController.EntityTypeDesc === 'Head Office of a Branch'
            ">
            <label>Full Name of Entity</label>
            <input [(ngModel)]="selectedController.OtherEntityName" name="fullName" [readonly]="!isEditable"
              required />
          </div>
          <div class="input-field" *ngIf="
              selectedController.EntityTypeDesc === 'UBO - Individual' ||
              selectedController.EntityTypeDesc === 'Individual Controller'
            ">
            <label for="title"> Title </label>
            <ng-container *ngIf="isEditable; else titleDisplay">
              <select [(ngModel)]="selectedController.Title" name="title" id="title">
                <option *ngFor="let title of TitleEdit" [value]="title.TitleTypeId">
                  {{ title.TitleDesc }}
                </option>
              </select>
            </ng-container>
            <ng-template #titleDisplay>
              <input [value]="selectedController.Title" name="title" id="title" readonly />
            </ng-template>
          </div>
          <div class="input-field" *ngIf="
              selectedController.EntityTypeDesc === 'UBO - Individual' ||
              selectedController.EntityTypeDesc === 'Individual Controller'
            ">
            <label for="firstName">
              First Name <span style="color: red">*</span>
            </label>
            <input [(ngModel)]="selectedController.FirstName" name="firstName" id="firstName" type="text"
              [readonly]="!isEditable" />
          </div>
          <!---->
          <div class="input-field" *ngIf="
              selectedController.EntityTypeDesc === 'UBO - Individual' ||
              selectedController.EntityTypeDesc === 'Individual Controller'
            ">
            <label for="secondName">
              Second Name <span style="color: red">*</span>
            </label>
            <input [(ngModel)]="selectedController.SecondName" name="secondName" id="secondName" type="text"
              [readonly]="!isEditable" />
          </div>
          <!---->
          <div class="input-field" *ngIf="
              selectedController.EntityTypeDesc === 'UBO - Individual' ||
              selectedController.EntityTypeDesc === 'Individual Controller'
            ">
            <label for="familyName">
              Family Name <span style="color: red">*</span>
            </label>
            <input [(ngModel)]="selectedController.FamilyName" name="familyName" id="familyName" type="text"
              [readonly]="!isEditable" />
          </div>
          <div class="input-field" *ngIf="
              CreatecontrollerDetails.EntityTypeDesc === 'UBO - Individual' ||
              CreatecontrollerDetails.EntityTypeDesc ===
                'Individual Controller'
            ">
            <label for="placeOfBirth"> Place of birth </label>
            <ng-container *ngIf="isEditable; else placeOfBirthDisplay">
              <select required [(ngModel)]="CreatecontrollerDetails.PlaceOfBirth" name="placeOfBirth"
                id="placeOfBirth">
                <option *ngFor="let place of allCountries" [value]="place.CountryID">
                  {{ place.CountryName }}
                </option>
              </select>
            </ng-container>
            <ng-template #placeOfBirthDisplay>
              <input [value]="selectedController.PlaceOfBirth" name="placeOfBirth" id="placeOfBirth" readonly />
            </ng-template>
          </div>

          <!---->
          <div class="input-field" *ngIf="
              selectedController.EntityTypeDesc === 'UBO - Individual' ||
              selectedController.EntityTypeDesc === 'Individual Controller'
            ">
            <label for="dateOfBirth">
              Date of birth <span style="color: red">*</span>
            </label>
            <input [(ngModel)]="selectedController.DateOfBirth" #dateInputs placeholder name="dateOfBirth" id="dateOfBirth"
              type="input" [readonly]="!isEditable" />
          </div>
          <!---->
          <div class="input-field" *ngIf="
              selectedController.EntityTypeDesc === 'UBO - Individual' ||
              selectedController.EntityTypeDesc === 'Individual Controller'
            ">
            <label for="passportNum"> Passport Number </label>
            <input [(ngModel)]="selectedController.PassportNum" name="passportNum" id="passportNum" type="text"
              [readonly]="!isEditable" />
          </div>
          <div class="input-field" *ngIf="
              selectedController.EntityTypeDesc === 'UBO - Individual' ||
              selectedController.EntityTypeDesc === 'Individual Controller'
            ">
            <label for="jurisdictionIssue"> Jurisdiction of Issue </label>
            <select name="jurisdictionIssue" id="jurisdictionIssue">
              <option value="select">Select</option>
            </select>
          </div>

          <!---->
          <div class="input-field" style="width: 100%" *ngIf="
              selectedController.EntityTypeDesc === 'UBO - Individual' ||
              selectedController.EntityTypeDesc === 'Individual Controller'
            ">
            <label for="isPEP">
              Is Politically Exposed Person (PEP)?
              <span style="color: red">*</span>
            </label>
            <div class="radio-wrapper">
              <input name="isPEP" id="yes" type="radio" [value]="true" [(ngModel)]="selectedController.IsPEP" />
              Yes
              <input name="isPEP" id="no" type="radio" [value]="false" [(ngModel)]="selectedController.IsPEP" />
              No
            </div>
          </div>
          <!---->
          <div class="input-field">
            <label>Legal Status</label>
            <ng-container *ngIf="isEditable; else legalStatusDisplay">
              <select [(ngModel)]="selectedController.LegalStatusTypeID" name="legalStatus">
                <option *ngFor="let status of legalStatusOptionsEdit" [value]="status.LegalStatusTypeID">
                  {{ status.LegalStatusTypeDesc }}
                </option>
              </select>
            </ng-container>
            <ng-template #legalStatusDisplay>
              <input [value]="getLegalStatusDescription()" name="legalStatus" readonly />
            </ng-template>
          </div>
          <div class="input-field">
            <label>Registered Number</label>
            <input [(ngModel)]="selectedController.RegisteredNum" name="registeredNum" [readonly]="!isEditable" />
          </div>
          <div class="input-field">
            <label>Place of Establishment:</label>
            <ng-container *ngIf="isEditable; else placeOfEstablishmentDisplay">
              <select required [(ngModel)]="selectedController.PlaceOfEstablishment" name="placeOfEstablishment">
                <option *ngFor="let place of allCountries" [value]="place.CountryID">
                  {{ place.CountryName }}
                </option>
              </select>
            </ng-container>
            <ng-template #placeOfEstablishmentDisplay>
              <input [value]="getPlaceOfEstablishmentName()" name="placeOfEstablishment" readonly />
            </ng-template>
          </div>

          <div class="input-field">
            <label for="typeOfControl">Type of Control</label>
            <ng-container *ngIf="isEditable; else typeOfControlDisplay">
              <select required [(ngModel)]="selectedController.ControllerControlTypeID"
                (ngModelChange)="updateControlTypeDesc($event)" name="typeOfControl" id="typeOfControl">
                <option *ngFor="let ControlType of controlTypeOptionsCreate"
                  [value]="ControlType.ControllerControlTypeID">
                  {{ ControlType.ControllerControlTypeDesc }}
                </option>
              </select>
            </ng-container>
            <ng-template #typeOfControlDisplay>
              <input [value]="selectedController.ControllerControlTypeDesc" name="placeOfEstablishment" readonly />
            </ng-template>
          </div>
          <!-- Display the % of Holding field only if the control type is "Percentage" -->
          <ng-container *ngIf="selectedController.ControllerControlTypeID == 1">
            <div class="input-field">
              <label>% of Holding</label>
              <input [(ngModel)]="selectedController.PctOfShares" name="percentOfHolding" type="text"
                [readonly]="!isEditable" />
            </div>
          </ng-container>
          <div class="input-field">
            <label>Effective Date</label>
            <ng-container *ngIf="isEditable; else effectiveDateInput">
              <input type="text" #dateInputs placeholder [(ngModel)]="selectedController.AssnDateFrom" name="effectiveDate" />
            </ng-container>
            <ng-template #effectiveDateInput>
              <input [(ngModel)]="selectedController.AssnDateFrom" name="effectiveDate" [readonly]="!isEditable" />
            </ng-template>
          </div>
          <div class="input-field">
            <label>Cessation Date</label>
            <ng-container *ngIf="isEditable; else cessationDateInput">
              <input type="text" #dateInputs placeholder [(ngModel)]="selectedController.AssnDateTo" name="cessationDate" />
            </ng-container>
            <ng-template #cessationDateInput>
              <input [(ngModel)]="selectedController.AssnDateTo" name="cessationDate" [readonly]="!isEditable" />
            </ng-template>
          </div>
          <div class="input-field" *ngIf="
              selectedController.EntityTypeDesc === 'Parent Entity' ||
              selectedController.EntityTypeDesc === 'Corporate Controller' ||
              selectedController.EntityTypeDesc === 'UBO – Corporate' ||
              selectedController.EntityTypeDesc === 'Head Office of a Branch'
            ">
            <label>Is The Company Regulated</label>
            <ng-container *ngIf="isEditable; else regulatedValue">
              <div style="display: flex; align-items: center">
                <input type="radio" id="regulatedYes" [(ngModel)]="selectedController.IsCompanyRegulated"
                  name="isCompanyRegulated" [value]="true" style="margin-right: 10px; cursor: pointer" />
                <label for="regulatedYes" style="margin-left: 5px; color: #413b3c">Yes</label>

                <input type="radio" id="regulatedNo" [(ngModel)]="selectedController.IsCompanyRegulated"
                  name="isCompanyRegulated" [value]="false" style="
                    margin-left: 20px;
                    margin-right: 10px;
                    cursor: pointer;
                  " />
                <label for="regulatedNo" style="margin-left: 5px; color: #413b3c">No</label>
              </div>
            </ng-container>
            <ng-template #regulatedValue>
              <span style="margin-left: 10px; color: #413b3c">
                {{ selectedController.IsCompanyRegulated ? 'Yes' : 'No' }}
              </span>
            </ng-template>
          </div>
          <div class="input-field" *ngIf="
              selectedController.EntityTypeDesc === 'Parent Entity' ||
              selectedController.EntityTypeDesc === 'Corporate Controller' ||
              selectedController.EntityTypeDesc === 'UBO – Corporate' ||
              selectedController.EntityTypeDesc === 'Head Office of a Branch'
            ">
            <label for="isParent">Is it also Parent / Corporate Controller?</label>
            <ng-container *ngIf="isEditable; else parentValue">
              <div style="display: flex; align-items: center">
                <input type="radio" id="parentYes" [(ngModel)]="selectedController.IsParentController" name="isParent"
                  [value]="true" style="margin-right: 10px; cursor: pointer" />
                <label for="parentYes" style="margin-left: 5px; color: #413b3c">Yes</label>

                <input type="radio" id="parentNo" [(ngModel)]="selectedController.IsParentController" name="isParent"
                  [value]="false" style="
                    margin-left: 20px;
                    margin-right: 10px;
                    cursor: pointer;
                  " />
                <label for="parentNo" style="margin-left: 5px; color: #413b3c">No</label>
              </div>
            </ng-container>
            <ng-template #parentValue>
              <span style="margin-left: 10px; color: #413b3c">
                {{ selectedController.IsParentController ? 'Yes' : 'No' }}
              </span>
            </ng-template>
          </div>

          <div class="input-field" *ngIf="selectedController.EntityTypeDesc === 'UBO – Corporate'">
            <label for="isCompanyTraded">Is the company publicly traded?</label>
            <ng-container *ngIf="isEditable; else tradedValue">
              <div style="display: flex; align-items: center">
                <input type="radio" id="tradedYes" [(ngModel)]="selectedController.IsPublicallyTraded"
                  name="isCompanyTraded" [value]="true" style="margin-right: 10px; cursor: pointer" />
                <label for="tradedYes" style="margin-left: 5px; color: #413b3c">Yes</label>

                <input type="radio" id="tradedNo" [(ngModel)]="selectedController.IsPublicallyTraded"
                  name="isCompanyTraded" [value]="false" style="
                    margin-left: 20px;
                    margin-right: 10px;
                    cursor: pointer;
                  " />
                <label for="tradedNo" style="margin-left: 5px; color: #413b3c">No</label>
              </div>
            </ng-container>
            <ng-template #tradedValue>
              <span style="margin-left: 10px; color: #413b3c">
                {{ selectedController.IsPublicallyTraded ? 'Yes' : 'No' }}
              </span>
            </ng-template>
          </div>
          <div class="input-field" *ngIf="
              selectedController.IsPublicallyTraded === false &&
              selectedController.EntityTypeDesc === 'UBO – Corporate'
            ">
            <label for="more10UBOs">Are there any UBOs that own more than 10% of this
              entity?</label>
            <ng-container *ngIf="isEditable; else moreUBOsValue">
              <div style="display: flex; align-items: center">
                <input type="radio" id="UBOYes" [(ngModel)]="selectedController.More10UBOs" name="more10UBOs"
                  [value]="true" style="margin-right: 10px; cursor: pointer" />
                <label for="UBOYes" style="margin-left: 5px; color: #413b3c">Yes</label>

                <input type="radio" id="UBONo" [(ngModel)]="selectedController.More10UBOs" name="more10UBOs"
                  [value]="false" style="
                    margin-left: 20px;
                    margin-right: 10px;
                    cursor: pointer;
                  " />
                <label for="UBONo" style="margin-left: 5px; color: #413b3c">No</label>
              </div>
            </ng-container>
            <ng-template #moreUBOsValue>
              <span style="margin-left: 10px; color: #413b3c">
                {{ selectedController.More10UBOs ? 'Yes' : 'No' }}
              </span>
            </ng-template>
          </div>
        </div>
        <div class="inputs-row">
          <div class="input-field additional-details fullwidth">
            <label for="additionalDetails"> Additional Details </label>
            <textarea [(ngModel)]="selectedController.AdditionalDetails" name="additionalDetails"
              id="additionalDetails" [readonly]="!isEditable"></textarea>
          </div>
        </div>
        <!-- Addresses Section -->
        <div class="addresses">
          <div class="popup-header">
            <h3>Addresses</h3>
          </div>
          <button (click)="addAddressForm()" *ngIf="canAddNewAddress" style="
            background-color: green;
            color: white;
            border: none;
            padding: 5px;
            cursor: pointer;
            border-radius: 5px;
            float: right;
          ">
          <i style="size: 7px" class="bi bi-plus-lg"></i>
        </button>
          <!-- Address Details -->
          <div *ngFor="let address of filteredControllerfirmAddresses; let i = index">
          <ng-container *ngIf="address.Valid === true">
            <hr />
            <button (click)="removeControllerAddress(i)"  style="
                float: right;
                background-color: red;
                color: white;
                border: none;
                padding: 5px;
                cursor: pointer;
                border-radius: 5px;
              ">
              <i style="size: 5px" class="bi bi-x-lg"></i>
            </button>
            <div class="inputs-row">
              <div class="input-field">
                <label>Address Type</label>
                <select [(ngModel)]="address.AddressTypeID" name="addressType" disabled>
                  <option *ngFor="let type of addressTypeOptionsEdit" [value]="type.AddressTypeID">
                    {{ type.AddressTypeDesc }}
                  </option>
                </select>
              </div>
              <div class="input-field">
                <label>Address - Line 1</label>
                <input type="text" [(ngModel)]="address.AddressLine1" name="addressLine1" id="addressLine1"
                  [readonly]="!isEditable" [disabled]="
                    address.sameAsTypeID && address.sameAsTypeID != 0
                  " />
              </div>
              <div class="input-field">
                <label>Address - Line 2</label>
                <input [(ngModel)]="address.AddressLine2" name="addressLine2" id="addressLine2"
                  [readonly]="!isEditable" [disabled]="
                    address.sameAsTypeID && address.sameAsTypeID != 0
                  " />
              </div>
            </div>
            <div class="inputs-row">
              <div class="input-field">
                <label for="address3"> Address - Line 3 </label>
                <input [(ngModel)]="address.AddressLine3" name="address3" id="address3" type="text" [disabled]="
                    address.sameAsTypeID && address.sameAsTypeID != 0
                  " [readonly]="!isEditable" />
              </div>

              <div class="input-field">
                <label for="address4"> Address - Line 4 </label>
                <input [(ngModel)]="address.AddressLine4" name="address4" id="address4" type="text" [disabled]="
                    address.sameAsTypeID && address.sameAsTypeID != 0
                  " [readonly]="!isEditable" />
              </div>
              <div class="input-field">
                <label for="city">City</label>
                <input [(ngModel)]="address.City" name="city" id="city" type="text" [disabled]="
                    address.sameAsTypeID && address.sameAsTypeID != 0
                  " [readonly]="!isEditable" />
              </div>
            </div>
            <div class="inputs-row">
              <div class="input-field">
                <label for="stateProvince">State/Province</label>
                <input [(ngModel)]="address.Province" name="stateProvince" id="stateProvince" [disabled]="
                    address.sameAsTypeID && address.sameAsTypeID != 0
                  " [readonly]="!isEditable" />
              </div>
              <div class="input-field">
                <label for="country">Country</label>
                <ng-container *ngIf="isEditable; else countryInput">
                  <select [(ngModel)]="address.CountryID" name="country" [disabled]="
                      address.sameAsTypeID && address.sameAsTypeID != 0
                    ">
                    <option *ngFor="let country of allCountries" [value]="country.CountryID">
                      {{ country.CountryName }}
                    </option>
                  </select>
                </ng-container>
                <ng-template #countryInput>
                  <input [(ngModel)]="address.CountryID" name="country" [readonly]="!isEditable" />
                </ng-template>
              </div>
              <div class="input-field">
                <label for="zipPostalCode">Zip/Postal Code</label>
                <input [(ngModel)]="address.PostalCode" name="zipPostalCode" id="zipPostalCode"
                  [readonly]="!isEditable" [disabled]="
                    address.sameAsTypeID && address.sameAsTypeID != 0
                  " />
              </div>
            </div>
          </ng-container>
          </div>
        </div>
        <ng-container *ngIf="
            !isEditable ||
            (isEditable && selectedController.IsCompanyRegulated)
          ">
          <div class="popup-header">
            <h3>Home State Regulators</h3>
          </div>

          <div *ngFor="let regulator of regulatorList; let i = index">
            <div class="inputs-row">
              <div class="input-field">
                <label for="regulators">Regulator <span style="color: red">*</span></label>
                <ng-container *ngIf="isEditable; else regulatorinput">
                  <select required [(ngModel)]="regulator.RegulatorName" name="regulators" id="regulators">
                    <option *ngFor="let Regulater of AllRegulater" [value]="Regulater.RegulatorID">
                      {{ Regulater.RegulatorName }}
                    </option>
                  </select>
                </ng-container>
                <ng-template #regulatorinput>
                  <input [(ngModel)]="regulator.RegulatorName" name="regulators" id="regulators"
                    [readonly]="!isEditable" />
                </ng-template>
              </div>
              <div class="input-field">
                <label>Regulator Contact</label>
                <input [(ngModel)]="selectedController.RegulatorContact" name="regulatorContact"
                  [readonly]="!isEditable" />
              </div>
            </div>
          </div>
        </ng-container>
        <div class="btn justify-content-end">
          <button *ngIf="!isEditable" (click)="editController()">
            <i class="bi bi-pen"></i> Edit
          </button>
          <button *ngIf="isEditable" (click)="saveControllerPopupChanges()">
            <i class="bi bi-save"></i> Save
          </button>
          <button (click)="confarmDeleteControllerDetials()">
            <i class="bi bi-trash"></i> Delete
          </button>
        </div>
      </form>
    </div>
  </div>
  <!-- heree -->
  <div *ngIf="showCreateControllerSection" class="contollerPopupOverlay">
    <div class="contollerPopupContent">
      <div class="popup-title-btn-row">
        <div class="popup-header">
          <h3>Controller For {{ firmDetails?.FirmName }}</h3>
        </div>
        <button (click)="closeCreateControllerPopup()" class="close-button">
          <i class="bi bi-x-circle close-icon"></i>
        </button>
        <div class="btn"></div>
      </div>

      <div class="error-messages">
        <p *ngIf="errorMessages['OtherEntityName']">
          {{ errorMessages['OtherEntityName'] }}
        </p>
        <p *ngIf="errorMessages['EffectiveDate']">
          {{ errorMessages['EffectiveDate'] }}
        </p>
        <p *ngIf="errorMessages['CessationDate']">
          {{ errorMessages['CessationDate'] }}
        </p>
        <p *ngIf="errorMessages['PlaceOfEstablishment']">
          {{ errorMessages['PlaceOfEstablishment'] }}
        </p>
        <p *ngIf="errorMessages['ControllerControlTypeDesc']">
          {{ errorMessages['ControllerControlTypeDesc'] }}
        </p>
        <p *ngIf="errorMessages['PctOfShares']">
          {{ errorMessages['PctOfShares'] }}
        </p>
      </div>
      <div class="inputs-row">
        <div class="input-field">
          <label for="controllerType">
            Controller Type <span style="color: red">*</span>
          </label>
          <select name="controllerType" id="controllerType" [(ngModel)]="CreatecontrollerDetails"
            (change)="changeControlType()">
            <option value="select" selected>Select</option>
            <option *ngFor="let controllerType of controllerTypeOption" [ngValue]="controllerType">
              {{ controllerType.EntityTypeDesc }}
            </option>
          </select>
        </div>
        <ng-container *ngIf="!hideForms">
          <div class="input-field" *ngIf="
              CreatecontrollerDetails.EntityTypeDesc === 'Parent Entity' ||
              CreatecontrollerDetails.EntityTypeDesc ===
                'Corporate Controller' ||
              CreatecontrollerDetails.EntityTypeDesc === 'UBO – Corporate' ||
              CreatecontrollerDetails.EntityTypeDesc ===
                'Head Office of a Branch'
            ">
            <label for="entityName">
              Full Name of Entity <span style="color: red">*</span>
            </label>
            <input name="entityName" id="entityName" [(ngModel)]="CreatecontrollerDetails.OtherEntityName"
              type="text" />
          </div>
          <!---->
          <div class="input-field" *ngIf="
              CreatecontrollerDetails.EntityTypeDesc === 'UBO - Individual' ||
              CreatecontrollerDetails.EntityTypeDesc ===
                'Individual Controller'
            ">
            <label for="individualTitle"> Title </label>
            <select [(ngModel)]="CreatecontrollerDetails.Title" name="legalStatus">
              <option *ngFor="let title of TitleEdit" [value]="title.TitleTypeId">
                {{ title.TitleDesc }}
              </option>
            </select>
          </div>
          <!---->
          <div class="input-field" *ngIf="
              CreatecontrollerDetails.EntityTypeDesc === 'UBO - Individual' ||
              CreatecontrollerDetails.EntityTypeDesc ===
                'Individual Controller'
            ">
            <label for="firstName">
              First Name <span style="color: red">*</span>
            </label>
            <input [(ngModel)]="CreatecontrollerDetails.FirstName" name="firstName" id="firstName" type="text" />
          </div>
          <!---->
          <div class="input-field" *ngIf="
              CreatecontrollerDetails.EntityTypeDesc === 'UBO - Individual' ||
              CreatecontrollerDetails.EntityTypeDesc ===
                'Individual Controller'
            ">
            <label for="secondName">
              Second Name <span style="color: red">*</span>
            </label>
            <input [(ngModel)]="CreatecontrollerDetails.SecondName" name="secondName" id="secondName" type="text" />
          </div>
          <!---->
          <div class="input-field" *ngIf="
              CreatecontrollerDetails.EntityTypeDesc === 'UBO - Individual' ||
              CreatecontrollerDetails.EntityTypeDesc ===
                'Individual Controller'
            ">
            <label for="familyName">
              Family Name <span style="color: red">*</span>
            </label>
            <input [(ngModel)]="CreatecontrollerDetails.FamilyName" name="familyName" id="familyName" type="text" />
          </div>
          <!---->
          <div class="input-field" *ngIf="
              CreatecontrollerDetails.EntityTypeDesc === 'UBO - Individual' ||
              CreatecontrollerDetails.EntityTypeDesc ===
                'Individual Controller'
            ">
            <label for="placeOfBirth"> Place of birth </label>
            <select required [(ngModel)]="CreatecontrollerDetails.PlaceOfBirth" name="placeOfBirth">
              <option *ngFor="let place of allCountries" [value]="place.CountryID">
                {{ place.CountryName }}
              </option>
            </select>
          </div>
          <!---->
          <div class="input-field" *ngIf="
              CreatecontrollerDetails.EntityTypeDesc === 'UBO - Individual' ||
              CreatecontrollerDetails.EntityTypeDesc ===
                'Individual Controller'
            ">
            <label for="dateOfBirth">
              Date of birth <span style="color: red">*</span>
            </label>
            <input [(ngModel)]="CreatecontrollerDetails.DateOfBirth" #dateInputs placeholder name="dateOfBirth" id="dateOfBirth"
              type="input" />
          </div>
          <!---->
          <div class="input-field" *ngIf="
              CreatecontrollerDetails.EntityTypeDesc === 'UBO - Individual' ||
              CreatecontrollerDetails.EntityTypeDesc ===
                'Individual Controller'
            ">
            <label for="passportNum"> Passport Number </label>
            <input [(ngModel)]="CreatecontrollerDetails.PassportNum" name="passportNum" id="passportNum"
              type="text" />
          </div>
          <!---->
          <div class="input-field" *ngIf="
              CreatecontrollerDetails.EntityTypeDesc === 'UBO - Individual' ||
              CreatecontrollerDetails.EntityTypeDesc ===
                'Individual Controller'
            ">
            <label for="jurisdictionIssue"> Jurisdiction of Issue </label>
            <select name="jurisdictionIssue" id="jurisdictionIssue">
              <option value="select">Select</option>
            </select>
          </div>
          <!---->
          <div class="input-field" style="width: 100%" *ngIf="
              CreatecontrollerDetails.EntityTypeDesc === 'UBO - Individual' ||
              CreatecontrollerDetails.EntityTypeDesc ===
                'Individual Controller'
            ">
            <label for="isPEP">
              Is Politically Exposed Person (PEP)?
              <span style="color: red">*</span>
            </label>
            <div class="radio-wrapper">
              <input name="isPEP" id="yes" type="radio" [value]="true" [(ngModel)]="CreatecontrollerDetails.IsPEP" />
              Yes
              <input name="isPEP" id="no" type="radio" [value]="false" [(ngModel)]="CreatecontrollerDetails.IsPEP" />
              No
            </div>
          </div>
          <!---->
          <div class="input-field" *ngIf="
              CreatecontrollerDetails.EntityTypeDesc === 'Parent Entity' ||
              CreatecontrollerDetails.EntityTypeDesc ===
                'Corporate Controller' ||
              CreatecontrollerDetails.EntityTypeDesc === 'UBO – Corporate' ||
              CreatecontrollerDetails.EntityTypeDesc ===
                'Head Office of a Branch'
            ">
            <label for="legalStatus"> Legal Status </label>
            <select [(ngModel)]="CreatecontrollerDetails.LegalStatusTypeID" name="legalStatus">
              <option *ngFor="let status of legalStatusOptionsEdit" [value]="status.LegalStatusTypeID">
                {{ status.LegalStatusTypeDesc }}
              </option>
            </select>
          </div>
          <!---->
          <div class="input-field" *ngIf="
              CreatecontrollerDetails.EntityTypeDesc === 'Parent Entity' ||
              CreatecontrollerDetails.EntityTypeDesc ===
                'Corporate Controller' ||
              CreatecontrollerDetails.EntityTypeDesc === 'UBO – Corporate' ||
              CreatecontrollerDetails.EntityTypeDesc ===
                'Head Office of a Branch'
            ">
            <label for="registeredNumber"> Registered Number </label>
            <input [(ngModel)]="CreatecontrollerDetails.RegisteredNum" name="registeredNumber" id="registeredNumber"
              type="text" />
          </div>
          <!---->
          <div class="input-field" *ngIf="
              CreatecontrollerDetails.EntityTypeDesc === 'Parent Entity' ||
              CreatecontrollerDetails.EntityTypeDesc ===
                'Corporate Controller' ||
              CreatecontrollerDetails.EntityTypeDesc === 'UBO – Corporate' ||
              CreatecontrollerDetails.EntityTypeDesc ===
                'Head Office of a Branch'
            ">
            <label for="establishmentPlace">
              Place of Establishment <span style="color: red">*</span>
            </label>
            <select required [(ngModel)]="CreatecontrollerDetails.PlaceOfEstablishment" name="placeOfEstablishment">
              <option *ngFor="let place of allCountries" [value]="place.CountryID">
                {{ place.CountryName }}
              </option>
            </select>
          </div>
          <!---->
          <!-- Display the % of Holding field only if the control type is "Percentage" -->

          <div class="input-field">
            <label for="controlType">
              Type of Control <span style="color: red">*</span>
            </label>
            <select required [(ngModel)]="CreatecontrollerDetails.ControllerControlTypeID" name="typeOfControl"
              id="typeOfControl" (ngModelChange)="CreateControlTypeDesc($event)">
              <option *ngFor="let ControlType of controlTypeOptionsCreate"
                [value]="ControlType.ControllerControlTypeID">
                {{ ControlType.ControllerControlTypeDesc }}
              </option>
            </select>
          </div>

          <!-- Conditionally show the 'Percentage' input if the type is 'Percentage' -->
          <ng-container *ngIf="CreatecontrollerDetails.ControllerControlTypeID == 1">
            <div class="input-field">
              <label for="holdingsPercentage"> % of Holding </label>
              <input [(ngModel)]="CreatecontrollerDetails.PctOfShares" name="holdingsPercentage"
                id="holdingsPercentage" type="text" />
            </div>
          </ng-container>

          <!---->
          <div class="input-field">
            <label for="effectiveDate"> Effective Date </label>
            <input [(ngModel)]="CreatecontrollerDetails.AssnDateFrom" name="effectiveDate" id="effectiveDate"
              #dateInputs placeholder type="text" />
          </div>
          <!---->
          <div class="input-field">
            <label for="cessationDate"> Cessation Date </label>
            <input [(ngModel)]="CreatecontrollerDetails.AssnDateTo" name="cessationDate" id="cessationDate"
              #dateInputs placeholder type="text" />
          </div>
          <!---->
          <div class="input-field" *ngIf="
              CreatecontrollerDetails.EntityTypeDesc === 'Parent Entity' ||
              CreatecontrollerDetails.EntityTypeDesc ===
                'Corporate Controller' ||
              CreatecontrollerDetails.EntityTypeDesc === 'UBO – Corporate' ||
              CreatecontrollerDetails.EntityTypeDesc ===
                'Head Office of a Branch'
            ">
            <label for="isRegulated"> Is the company regulated : </label>
            <div class="radio-wrapper">
              <input name="isRegulated" id="yes" type="radio" [(ngModel)]="CreatecontrollerDetails.IsCompanyRegulated"
                [value]="true" />
              Yes
              <input name="isRegulated" id="no" type="radio" [(ngModel)]="CreatecontrollerDetails.IsCompanyRegulated"
                [value]="false" />
              No
            </div>
          </div>
          <!---->
          <div class="input-field" *ngIf="
              CreatecontrollerDetails.EntityTypeDesc === 'UBO – Corporate'
            ">
            <label for="isParent">
              Is it also Parent / Corporate Controller? :
            </label>
            <div class="radio-wrapper">
              <input name="isParent" id="yes" type="radio" [(ngModel)]="CreatecontrollerDetails.IsParentController" />
              Yes
              <input name="isParent" id="no" type="radio" [(ngModel)]="CreatecontrollerDetails.IsParentController" />
              No
            </div>
          </div>
          <!---->
          <div class="input-field" *ngIf="
              CreatecontrollerDetails.EntityTypeDesc === 'UBO – Corporate'
            ">
            <label for="isCompanyTraded">
              Is the company publicly traded :
            </label>
            <div class="radio-wrapper">
              <input name="isCompanyTraded" id="yes" type="radio"
                [(ngModel)]="CreatecontrollerDetails.IsPublicallyTraded" [value]="true" />
              Yes
              <input name="isCompanyTraded" id="no" type="radio"
                [(ngModel)]="CreatecontrollerDetails.IsPublicallyTraded" [value]="false" />
              No
            </div>
          </div>
          <!---->
          <div class="input-field" *ngIf="
              CreatecontrollerDetails.IsPublicallyTraded === false &&
              CreatecontrollerDetails.EntityTypeDesc === 'UBO – Corporate'
            ">
            <label for="more10UBOs">
              Are there any UBOs that own more than 10% of this entity? :
            </label>
            <div class="radio-wrapper">
              <input name="more10UBOs" id="yes" type="radio" [(ngModel)]="CreatecontrollerDetails.More10UBOs"
                [value]="true" />
              Yes
              <input name="more10UBOs" id="no" type="radio" [(ngModel)]="CreatecontrollerDetails.More10UBOs"
                [value]="false" />
              No
            </div>
          </div>

          <div class="input-field additional-details fullwidth">
            <label for="additionalDetails"> Additional Details </label>
            <textarea [(ngModel)]="CreatecontrollerDetails.AdditionalDetails" name="additionalDetails"
              id="additionalDetails"></textarea>
          </div>
          <!---->
        </ng-container>
      </div>
      <div *ngIf="!hideForms" class="addresses create--inputs-field-set">
        <div class="popup-header">
          <h3>Addresses</h3>
          <button (click)="addAddressForm()" [disabled]="addressForms.length >= 3" style="
              background-color: green;
              color: white;
              border: none;
              padding: 5px;
              cursor: pointer;
              border-radius: 5px;
              float: right;
            ">
            <i style="size: 7px" class="bi bi-plus-lg"></i>
          </button>
        </div>
        <div *ngFor="let address of addressForms; let i = index">
          <hr />
          <button (click)="removeAddressForm(i)" style="
              float: right;
              background-color: red;
              color: white;
              border: none;
              padding: 5px;
              cursor: pointer;
              border-radius: 5px;
            ">
            <i style="size: 5px" class="bi bi-x-lg"></i>
          </button>

          <div class="inputs-row">
            <!-- Address Type -->
            <div class="input-field">
              <label for="addressType"> Address Type </label>
              <select [(ngModel)]="address.AddressTypeID" (change)="onAddressTypeChange($event, address)" [ngClass]="{
                  'error-border':
                    !address.AddressTypeID && errorMessages['AddressTypeID'],
                  
                }" [disabled]="address.sameAsTypeID && address.sameAsTypeID != 0">
                <!-- Disable if Same As Type is selected -->
                <option value="0">Select</option>
                <option *ngFor="let option of allAddressTypes" [value]="option.AddressTypeID">
                  {{ option.AddressTypeDesc }}
                </option>
              </select>
            </div>

            <!-- Same As Type (only for forms after the first one) -->
            <div *ngIf="i > 0" class="input-field">
              <label for="sameAsType">Same As Type</label>
              <select [(ngModel)]="address.sameAsTypeID" (change)="onSameAsTypeChangeg($event, address)" [ngClass]="{
                  'error-border':
                    !address.sameAsTypeID && errorMessages['sameAsTypeID'],
                  
                }" id="sameAsType" name="sameAsType">
                <option value="0">Select</option>
                <!-- Dynamically populate the options from previous forms' AddressTypeID -->
                <option *ngFor="let form of addressForms.slice(0, i)" [value]="form.AddressTypeID">
                  {{ getAddressTypeDesc(form.AddressTypeID) }}
                </option>
              </select>
            </div>

            <!-- Other fields will be disabled if Same As Type has a value -->
            <div class="input-field">
              <label for="address1"> Address - Line 1 </label>
              <input [(ngModel)]="address.addressLine1" name="address1" id="address1" type="text"
                [disabled]="address.sameAsTypeID && address.sameAsTypeID != 0" />
            </div>

            <div class="input-field">
              <label for="address2"> Address - Line 2 </label>
              <input [(ngModel)]="address.addressLine2" name="address2" id="address2" type="text"
                [disabled]="address.sameAsTypeID && address.sameAsTypeID != 0" />
            </div>

            <div class="input-field">
              <label for="address3"> Address - Line 3 </label>
              <input [(ngModel)]="address.addressLine3" name="address3" id="address3" type="text"
                [disabled]="address.sameAsTypeID && address.sameAsTypeID != 0" />
            </div>

            <div class="input-field">
              <label for="address4"> Address - Line 4 </label>
              <input [(ngModel)]="address.addressLine4" name="address4" id="address4" type="text"
                [disabled]="address.sameAsTypeID && address.sameAsTypeID != 0" />
            </div>

            <div class="input-field">
              <label for="city"> City </label>
              <input [(ngModel)]="address.city" name="city" id="city" type="text"
                [disabled]="address.sameAsTypeID && address.sameAsTypeID != 0" />
            </div>

            <div class="input-field">
              <label for="state"> State/Province </label>
              <input [(ngModel)]="address.stateProvince" name="state" id="state" type="text"
                [disabled]="address.sameAsTypeID && address.sameAsTypeID != 0" />
            </div>

            <div class="input-field">
              <label for="country"> Country </label>
              <select required [(ngModel)]="address.CountryID" (change)="getAllRegulater(+address.CountryID, firmId)"
                name="Country" id="Country" [disabled]="address.sameAsTypeID && address.sameAsTypeID != 0">
                <option *ngFor="let place of allCountries" [value]="place.CountryID">
                  {{ place.CountryName }}
                </option>
              </select>
            </div>

            <div class="input-field">
              <label for="zipCode"> Zip/Postal Code </label>
              <input [(ngModel)]="address.zipPostalCode" name="zipCode" id="zipCode" type="text"
                [disabled]="address.sameAsTypeID && address.sameAsTypeID != 0" />
            </div>
          </div>
        </div>
      </div>

      <div class="create--inputs-field-set" *ngIf="CreatecontrollerDetails.IsCompanyRegulated === true">
        <div class="create-controller-actions">
          <h2 class="create-controller-header">Home State Regulators</h2>
        </div>

        <!-- Add regulator button -->

        <button (click)="addRegulator()" style="
            background-color: green;
            color: white;
            border: none;
            padding: 5px;
            cursor: pointer;
            border-radius: 5px;
            float: right;
          ">
          <i style="size: 7px" class="bi bi-plus-lg"></i>
        </button>

        <!-- Dynamically generate form inputs for each regulator in regulatorList -->
        <div *ngFor="let regulator of regulatorList; let i = index" class="create-controller-inputs">
          <hr />
          <div style="width: 100%">
            <button (click)="removeRegulator(i)" style="
                float: right;
                background-color: red;
                color: white;
                border: none;
                padding: 5px;
                cursor: pointer;
                border-radius: 5px;
              ">
              <i style="size: 5px" class="bi bi-x-lg"></i>
            </button>
          </div>
          <div class="input-field home-state-regulators-container">
            <!-- Regulator Name input -->
            <div class="regulator-select-container">
              <label for="regulators">Regulator <span style="color: red">*</span></label>
              <select required [(ngModel)]="regulator.RegulatorName" name="regulators" id="regulators">
                <option *ngFor="let Regulater of AllRegulater" [value]="Regulater.RegulatorID">
                  {{ Regulater.RegulatorName }}
                </option>
              </select>
            </div>
            <!-- Remove button for each regulator -->
          </div>

          <!-- Regulator Contact input (disabled as per your code) -->
          <div class="input-field regulator-contact-container">
            <label for="regulatorContact-{{ i }}">Regulator Contact</label>
            <input disabled type="text" [(ngModel)]="regulator.RegulatorContacts" name="regulatorContact-{{ i }}"
              id="regulatorContact-{{ i }}" />
          </div>
        </div>
      </div>
      <div class="btn justify-content-end">
        <button class="save-btn" (click)="createControllerPopupChanges()">
          Save
        </button>
      </div>
    </div>
  </div>
</div>