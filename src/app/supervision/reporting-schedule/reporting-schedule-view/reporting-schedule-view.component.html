<app-loader *ngIf="isLoading"></app-loader>
<div class="overlay">
    <div class="popupcontainer Rptpopupcontainer NoAnimationPopup" style="display:block"
        (click)="$event.stopPropagation()">
        <div class="error-messages">
            <p *ngIf="errorMessages['financialReportingPeriod']">
                {{ errorMessages['financialReportingPeriod'] }}
            </p>
            <p *ngIf="errorMessages['FirmRptFrom']">
                {{ errorMessages['FirmRptFrom'] }}
            </p>
            <p *ngIf="errorMessages['FirmRptTo']">
                {{ errorMessages['FirmRptTo'] }}
            </p>
            <p *ngIf="errorMessages['FinancialDateFromCannotOrEqualLaterFinancialDateTo']">
                {{ errorMessages['FinancialDateFromCannotOrEqualLaterFinancialDateTo'] }}
            </p>
            <p *ngIf="errorMessages['DateFromEarlierThanLicensedAndAuthorised']">
                {{ errorMessages['DateFromEarlierThanLicensedAndAuthorised'] }}
            </p>
            <p *ngIf="errorMessages['FinancialSpanMoreThanAYear']">
                {{ errorMessages['FinancialSpanMoreThanAYear'] }}
            </p>
            <p *ngIf="errorMessages['ReportingScheduleGenerated']">
                {{ errorMessages['ReportingScheduleGenerated'] }}
            </p>
            <p *ngIf="errorMessages['CorrectReportingSchItem']">
                {{ errorMessages['CorrectReportingSchItem'] }}
            </p>
            <p *ngIf="errorMessages['rptNotScheduleGeneratePreviousReport']">
                {{ errorMessages['rptNotScheduleGeneratePreviousReport'] }}
            </p>
            <p *ngIf="errorMessages['rptNotScheduleForOneYearEarlier']">
                {{ errorMessages['rptNotScheduleForOneYearEarlier'] }}
            </p>
            <p *ngIf="errorMessages['financialPeriodMonthIsDifferent']">
                {{ errorMessages['financialPeriodMonthIsDifferent'] }}
            </p>
            <p *ngIf="errorMessages['fileAttached']">
                {{ errorMessages['fileAttached'] }}
            </p>
            <p *ngIf="errorMessages['scheduleItemRef']">
                {{ errorMessages['scheduleItemRef'] }}
            </p>
            <p *ngIf="errorMessages['rptScheduleReferenced']">
                {{ errorMessages['rptScheduleReferenced'] }}
            </p>
            <p *ngIf="errorMessages['docLinked']">
                {{ errorMessages['docLinked'] }}
            </p>
        </div>
        <!-- Title -->
        <div class="popup-title-btn-row">
            <div class="popup-header">
                <h3>
                    Reporting Schedule For {{ firmDetails?.FirmName }}
                </h3>
            </div>
            <button class="close-button  close-icon" (click)="onClose()">
                <i class="bi bi-x-circle"></i>
            </button>
        </div>


        <div class="reporting-schedule-form">
            <div class="inputs-row">
                <div class="input-field">
                    <label for="financialYearEnd">Financial year end selected to generate this reporting
                        schedule <span *ngIf="isEditModeReportingSch || isCreateReportingSch"
                            style="color: red;">*</span></label>
                    <select *ngIf="isEditModeReportingSch || isCreateReportingSch; else financialYearEnd"
                        [(ngModel)]="firmFinYearEndTypeID" [disabled]="DisableField">
                        <option *ngFor="let option of financialYearEndTypes" [value]="option.FirmFinYearEndTypeID">
                            {{option.FirmFinYearEnd}}
                        </option>
                    </select>
                    <ng-template #financialYearEnd>
                        <input type="text" id="financialYearEnd" name="financialYearEnd"
                            [(ngModel)]="financialReportingPeriod.FirmFinYearEndTypeDesc"
                            [disabled]="(!isEditModeReportingSch && !isCreateReportingSch) || DisableField" />
                    </ng-template>
                </div>
                <div class="input-field">
                    <label for="reportingScheduleFrom">Reporting Schedule From <span
                            *ngIf="isEditModeReportingSch || isCreateReportingSch" style="color: red;">*</span></label>
                    <input type="text" id="reportingScheduleFrom" name="reportingScheduleFrom" [(ngModel)]="firmRptFrom"
                        [disabled]="(!isEditModeReportingSch && !isCreateReportingSch) || DisableField" #dateInputs />
                </div>
                <div class="input-field">
                    <label for="reportingScheduleTo">Reporting Schedule To <span
                            *ngIf="isEditModeReportingSch || isCreateReportingSch" style="color: red;">*</span></label>
                    <input type="text" id="reportingScheduleTo" name="reportingScheduleTo" [(ngModel)]="firmRptTo"
                        [disabled]="(!isEditModeReportingSch && !isCreateReportingSch) || DisableField" #dateInputs />
                </div>
                <div *ngIf="!isEditModeReportingSch && !isCreateReportingSch" class="input-field">
                    <label for="reportType">Report Type</label>
                    <select id="reportType" [(ngModel)]="reportType" (change)="filterReports($event)">
                        <option value="1" selected>
                            All
                        </option>
                        <option value="2" selected>
                            Non - AML Reports
                        </option>
                        <option value="3" selected>
                            AML Reports
                        </option>
                    </select>
                </div>

                <div *ngIf="isEditModeReportingSch || isCreateReportingSch" class="input-field">
                    <label for="generate">Generate</label>
                    <div class="radio-wrapper">

                        <input [(ngModel)]="rptScheduleType" [disabled]="DisableField" type="radio" name="generate"
                            [value]="1" /> New

                        <input [(ngModel)]="rptScheduleType" [disabled]="DisableField" type="radio" name="generate"
                            [value]="2" />From Previous
                    </div>
                </div>

                <div *ngIf="isEditModeReportingSch || isCreateReportingSch" class="input-field">
                    <button (click)="generateReportSch()" [disabled]="DisableField" class="generate-btn">Generate
                        Reporting Schedule</button>
                </div>
            </div>

            <div *ngIf="!isEditModeReportingSch && !isCreateReportingSch && pnlPublishReportingSch"
                class="rpt-list margin-top-10 table">
                <div class="popup-header">
                    <h3>Publish Reporting Schedule</h3>
                </div>
                <ng-container *ngIf="publishDetails">
                    <div class="inputs-row">
                        <div class="input-field">
                            <label for="publishedBy">Published By</label>
                            <input disabled type="text" [(ngModel)]="report.PublishedByUserName" />
                        </div>
                        <div class="input-field">
                            <label for="publishedDate">Published Date</label>
                            <input disabled type="text" [(ngModel)]="report.WPublishedDate" />
                        </div>
                    </div>
                </ng-container>

                <ng-container *ngIf="publishButtons">
                    <div class="btn justify-content-end">
                        <button (click)="selectAllUnpublishedCheckbox()">
                            Select Un-published Reports
                        </button>

                        <button (click)="publishReports()">
                            {{publishBtnText}}
                        </button>
                    </div>
                </ng-container>

            </div>

            <div *ngIf="isCreateReportingSch ? reportsGenerated : true" class="rpt-list margin-top-10 table">
                <div class="popup-header">
                    <h3>Reports List</h3>

                    <!-- Action Buttons -->
                    <div class="btn justify-content-end">
                        <button *ngIf="!hideExportBtn">
                            <i class="bi bi-file-earmark-text"></i> Export to word
                        </button>

                        <button (click)="editReport()" *ngIf="getControlVisibility('imgBtnEdit') && !hideEditBtn"
                            [disabled]="!getControlEnablement('imgBtnEdit')">
                            <i class="bi bi-pen"></i> Edit
                        </button>

                        <button (click)="saveReport()" *ngIf="getControlVisibility('imgBtnSave') && !hideSaveBtn">
                            Save
                        </button>

                        <button class="cancel-btn" *ngIf="getControlVisibility('imgBtnCancel') && !hideCancelBtn"
                            (click)="cancelReport()">
                            Cancel
                        </button>

                        <button (click)="deleteReport()" *ngIf="getControlVisibility('imgBtnDelete') && !hideDeleteBtn">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </div>

                <div *ngIf="isEditModeReportingSch || isCreateReportingSch" class="add-rpt-btn-container">
                    <button class="addRptBtn" (click)="addNewReport()">
                        Add Report
                    </button>
                </div>
                <ng-container *ngFor="let rpt of displayedItems; let i = index">
                    <div class="inputs-row report-entry" [ngClass]="{ 'border-style': i !== 0 }">
                        <div *ngIf="rpt?.errorMessages?.['rptTypeChanged']" class="error-messages">
                            <p>
                                {{ rpt.errorMessages['rptTypeChanged'] }}
                            </p>
                        </div>
                        <div *ngIf="isEditModeReportingSch || isCreateReportingSch" class="del-rpt-container">
                            <button [disabled]="rpt.WFileAttached" *ngIf="displayedItems.length > 1"
                                (click)="removeReport(i)" class="RmvTrashBtn bi-trash"></button>
                        </div>
                        <div class="input-field">
                            <label for="reportTypeEntry">Report Type</label>
                            <select *ngIf="isEditModeReportingSch || isCreateReportingSch; else reportType"
                                [(ngModel)]="rpt.DocTypeID" (change)="onReportTypeChange(rpt)"
                                [disabled]="(!isValueNullOrEmpty(rpt.DocReceivedDate) || rpt.WFileAttached)">
                                <option [value]="0">Select</option>
                                <option *ngFor="let option of allReportTypes" [value]="option.DocTypeID">
                                    {{option.DocTypeDesc}}</option>
                            </select>
                            <ng-template #reportType>
                                <input type="text" id="reportTypeEntry" name="reportTypeEntry"
                                    [(ngModel)]="rpt.DocTypeDesc" disabled />
                            </ng-template>
                        </div>

                        <div class="input-field">
                            <label for="submissionType">Submission Type</label>
                            <select *ngIf="isEditModeReportingSch || isCreateReportingSch; else FirmRptSubmissionTypes"
                                [(ngModel)]="rpt.FirmRptSubmissionTypeID"
                                [disabled]="(!isValueNullOrEmpty(rpt.DocReceivedDate) || rpt.WFileAttached)"
                                (change)="onSubmissionTypeChange(rpt)">
                                <option [value]="0">Select</option>
                                <option *ngFor="let option of allRptSubmissionTypes"
                                    [value]="option.FirmRptSubmissionTypeID">
                                    {{option.SubmissionTypeDesc}}
                                </option>
                            </select>
                            <ng-template #FirmRptSubmissionTypes>
                                <input type="text" id="submissionType" name="submissionType"
                                    [(ngModel)]="rpt.FirmRptSubmissionTypeDesc" disabled />
                            </ng-template>

                        </div>

                        <div class="input-field">
                            <label for="publish">Publish</label>
                            <input type="checkbox" id="publish" name="publish" [(ngModel)]="rpt.WPublished"
                                [disabled]="rpt.WFileAttached" />
                        </div>

                        <div class="input-field">
                            <label for="reportingPeriodType">Reporting Period Type</label>
                            <select *ngIf="isEditModeReportingSch || isCreateReportingSch; else reportingPeriodType"
                                id="reportingPeriodType" [(ngModel)]="rpt.RptPeriodTypeID"
                                (change)="onRptPeriodTypeChange(rpt)"
                                [disabled]="(!isValueNullOrEmpty(rpt.DocReceivedDate) || rpt.WFileAttached)">
                                <option [value]="0">Select</option>
                                <option *ngFor="let option of rpt.periodTypes" [value]="option.RptPeriodTypeID">
                                    {{ option?.RptPeriodShortDesc }}
                                </option>
                            </select>
                            <ng-template #reportingPeriodType>
                                <input disabled [value]="rpt.RptPeriodShortDesc">
                            </ng-template>
                        </div>
                        <div class="input-field">
                            <label for="reportingPeriodStartDate">Reporting Period Start Date</label>
                            <input type="text" id="reportingPeriodStartDate" name="reportingPeriodStartDate"
                                (blur)="onRptPeriodTypeChange(rpt)" [(ngModel)]="rpt.RptPeriodFromDate"
                                [disabled]="(!isEditModeReportingSch && !isCreateReportingSch) || (!isValueNullOrEmpty(rpt.DocReceivedDate) || rpt.WFileAttached)"
                                #dateInputs />
                        </div>
                        <div class="input-field">
                            <label for="reportingPeriodEndDate">Reporting Period End Date</label>
                            <input type="text" id="reportingPeriodEndDate" name="reportingPeriodEndDate"
                                (blur)="onRptPeriodTypeChange(rpt)" [(ngModel)]="rpt.RptPeriodToDate"
                                [disabled]="(!isEditModeReportingSch && !isCreateReportingSch) || (!isValueNullOrEmpty(rpt.DocReceivedDate) || rpt.WFileAttached)"
                                #dateInputs />
                        </div>
                        <div class="input-field">
                            <label for="reportName">Report Name</label>
                            <input type="text" id="reportName" name="reportName" [(ngModel)]="rpt.ReportName"
                                [disabled]="(!isEditModeReportingSch && !isCreateReportingSch) || (!isValueNullOrEmpty(rpt.DocReceivedDate) || rpt.WFileAttached)" />
                        </div>
                        <div class="input-field">
                            <label for="dueDate">Due Date</label>
                            <input type="text" id="dueDate" name="dueDate" [(ngModel)]="rpt.FirmRptDueDate"
                                (blur)="onRptPeriodTypeChange(rpt)"
                                [disabled]="(!isEditModeReportingSch && !isCreateReportingSch) || (!isValueNullOrEmpty(rpt.DocReceivedDate) || rpt.WFileAttached)"
                                #dateInputs />
                        </div>
                        <div class="input-field">
                            <label for="required">Required</label>
                            <ng-container
                                *ngIf="isEditModeReportingSch || isCreateReportingSch; else FirmRptReqdBitValue">
                                <select (change)="onRequiredChange(rpt)" [(ngModel)]="rpt.FirmRptReqdBit"
                                    [disabled]="(!isValueNullOrEmpty(rpt.DocReceivedDate) || rpt.WFileAttached)">
                                    <option [value]="true">Yes</option>
                                    <option [value]="false">No</option>
                                </select>
                            </ng-container>
                            <ng-template #FirmRptReqdBitValue>
                                <input disabled [value]="rpt.FirmRptReqdBit ? 'Yes' : 'No'">
                            </ng-template>
                        </div>
                        <div *ngIf="rpt.FirmRptReqdBit === 'false' || rpt.FirmRptReqdBit === false" class="input-field">
                            <label for="notRequired">Not Required Reason</label>
                            <ng-container
                                *ngIf="isEditModeReportingSch || isCreateReportingSch; else FirmRptNReqdReason">
                                <select [(ngModel)]="rpt.FirmRptNReqReasonTypeID">
                                    <option [value]="0">Select</option>
                                    <option *ngFor="let option of allNotRequiredTypes"
                                        [value]="option.FirmRptNReqReasonTypeID">
                                        {{option.FirmRptNReqReasonTypeDesc}}
                                    </option>
                                </select>
                            </ng-container>

                            <ng-template #FirmRptNReqdReason>
                                <input disabled [(ngModel)]="rpt.FirmRptNReqReasonTypeDesc">
                            </ng-template>
                        </div>

                        <div *ngIf="!isValueNullOrEmpty(rpt.AdditionalSheets) && isXBRLTypeForReport(rpt.DocTypeID)"
                            class="input-field">
                            <label for="additionalSheets">Additional Forms Requested</label>
                            <input disabled [(ngModel)]="rpt.AdditionalSheets">
                        </div>

                        <div class="input-field">
                            <label for="reportLink">Link to Report</label>
                            <span *ngIf="rpt.documentDetails?.FileName">{{rpt.DocTypeDesc}} : <a id="websiteLink"
                                    [href]="rpt.DocFileLocation" target="_blank" rel="noopener noreferrer">
                                    {{rpt.documentDetails?.FileName}}
                                </a></span>
                            <a *ngIf="(isEditModeReportingSch || isCreateReportingSch) && !rpt.DocID"
                                class="form-ref-btn" href="javascript:void(0)"
                                (click)="openReferencePopup(rpt)">Select/De-select
                                document</a>
                        </div>

                        <div class="input-field">
                            <label for="reportGivenBy">Report Given By</label>
                            <ul class="signatories-list">
                                <li *ngFor="let userName of signatories[rpt.FirmRptSchItemID]">
                                    {{userName.WSignOffByUserName}} on {{userName.WSignOffDate}}</li>
                            </ul>
                        </div>

                        <div class="input-field">
                            <label for="receivedDate">Received Date</label>
                            <input type="text" id="receivedDate" name="receivedDate" [(ngModel)]="rpt.DocReceivedDate"
                                disabled />
                        </div>

                        <div class="input-field">
                            <label for="linkToReview">Link to Review</label>
                            <span>
                                <a *ngIf="rptItemExists[rpt.FirmRptSchItemID] && rptItemExists[rpt.FirmRptSchItemID] !== 0"
                                    [routerLink]="['/supervision/view/return-review', firmId]"
                                    [queryParams]="{ firmRptSchItemID: rpt.FirmRptSchItemID }" target="_blank">
                                    Link to Review
                                </a>
                                <!-- - <a href="#">Warnings</a> 
                                - <a href="#" *ngIf="rpt.showMIReport">MI Report</a> -->
                            </span>
                        </div>


                        <div class="input-field">
                            <label for="submissionStatus">Submission Status</label>
                            <input type="text" id="submissionStatus" name="submissionStatus"
                                [(ngModel)]="rpt.ObjectStatusTypeDesc" disabled />
                        </div>

                        <div class="input-field">
                            <label for="returnReviewStatus">Return Review Status</label>
                            <input type="text" id="returnReviewStatus" name="returnReviewStatus"
                                [(ngModel)]="rpt.ReviewStatusDesc" disabled />
                        </div>

                        <div class="input-field fullwidth">
                            <label for="notes">Notes</label>
                            <textarea [(ngModel)]="rpt.FirmRptNotes" name="notes" id="notes"
                                [disabled]="!isEditModeReportingSch && !isCreateReportingSch"></textarea>
                        </div>
                        <!-- Validation Errors -->
                        <div *ngIf="isEditModeReportingSch || isCreateReportingSch" class="error-messages">
                            <p *ngIf="rpt?.errorMessages?.['reportType']">
                                {{ rpt.errorMessages['reportType'] }}
                            </p>
                            <p *ngIf="rpt?.errorMessages?.['submissionType']">
                                {{ rpt.errorMessages['submissionType'] }}
                            </p>
                            <p *ngIf="rpt?.errorMessages?.['rptPeriodType']">
                                {{ rpt.errorMessages['rptPeriodType'] }}
                            </p>
                            <p *ngIf="rpt?.errorMessages?.['RptPeriodFromDate']">
                                {{ rpt.errorMessages['RptPeriodFromDate'] }}
                            </p>
                            <p *ngIf="rpt?.errorMessages?.['RptPeriodFromTo']">
                                {{ rpt.errorMessages['RptPeriodFromTo'] }}
                            </p>
                            <p *ngIf="rpt?.errorMessages?.['RptPeriodFromDateGreaterThanRptPeriodDateTo']">
                                {{ rpt.errorMessages['RptPeriodFromDateGreaterThanRptPeriodDateTo'] }}
                            </p>
                            <p *ngIf="rpt?.errorMessages?.['reportName']">
                                {{ rpt.errorMessages['reportName'] }}
                            </p>
                            <p *ngIf="rpt?.errorMessages?.['dueDate']">
                                {{ rpt.errorMessages['dueDate'] }}
                            </p>
                            <p *ngIf="rpt?.errorMessages?.['notRequired']">
                                {{ rpt.errorMessages['notRequired'] }}
                            </p>
                            <p *ngIf="rpt?.errorMessages?.['duplicateReport']">
                                {{ rpt.errorMessages['duplicateReport'] }}
                            </p>
                            <p *ngIf="rpt?.errorMessages?.['DUEDATE_SHOULDBE_BETWEEN_REPSCHFROM_TODATE']">
                                {{ rpt.errorMessages['DUEDATE_SHOULDBE_BETWEEN_REPSCHFROM_TODATE'] }}
                            </p>
                            <p *ngIf="rpt?.errorMessages?.['DUEDATE_GREATERTHAN_TODATE']">
                                {{ rpt.errorMessages['DUEDATE_GREATERTHAN_TODATE'] }}
                            </p>
                            <p *ngIf="rpt?.errorMessages?.['REPORTINGSTARTDATE_FIRSTDAY']">
                                {{ rpt.errorMessages['REPORTINGSTARTDATE_FIRSTDAY'] }}
                            </p>
                            <p *ngIf="rpt?.errorMessages?.['REPORTINGENDDATE_LASTDAY']">
                                {{ rpt.errorMessages['REPORTINGENDDATE_LASTDAY'] }}
                            </p>
                            <p *ngIf="rpt?.errorMessages?.['REPORTINGDATESINVALIDFORSELECTEDFREQUENCY']">
                                {{ rpt.errorMessages['REPORTINGDATESINVALIDFORSELECTEDFREQUENCY'] + ' ' +
                                rpt.RptFreqDesc }}
                            </p>
                            <p *ngIf="rpt?.errorMessages?.['EFFECTIVEREPORTTYPEDATE']">
                                {{ rpt.errorMessages['EFFECTIVEREPORTTYPEDATE'] }}
                            </p>
                        </div>
                    </div>
                </ng-container>
                <div>
                    <app-pagination [items]="filteredFirmRptDetails" [pageSize]="pageSize"
                        (paginatedItemsChange)="onPaginatedItemsChange($event)">
                    </app-pagination>
                </div>
            </div>
        </div>
    </div>
</div>

<app-reference-form *ngIf="showReferencePopup" [firmId]="firmId" [Page]="Page.ReportingSchedule"
    (close)="closeReferencePopup()" [docTypes]="currentDocTypeID" [documentDetails]="currentDocumentDetails"
    (documentSelected)="onDocumentSelected($event)" (documentDeselected)="onDocumentDeselected()"></app-reference-form>